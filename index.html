// script.js

const feedsPorCategoria = {
  "Internacional": "https://api.codetabs.com/v1/proxy?quest=https://feeds.bbci.co.uk/news/world/rss.xml",
  "Nacional": "https://api.codetabs.com/v1/proxy?quest=https://feeds.bbci.co.uk/news/world/rss.xml",
  "Europa": "https://api.codetabs.com/v1/proxy?quest=https://feeds.bbci.co.uk/news/world/rss.xml",
  "Deportes": "https://api.codetabs.com/v1/proxy?quest=https://feeds.bbci.co.uk/news/world/rss.xml",
  "Cultura": "https://api.codetabs.com/v1/proxy?quest=https://feeds.bbci.co.uk/news/world/rss.xml",
  "Tecnología": "https://api.codetabs.com/v1/proxy?quest=https://feeds.bbci.co.uk/news/world/rss.xml",
  "Ciencia": "https://api.codetabs.com/v1/proxy?quest=https://feeds.bbci.co.uk/news/world/rss.xml",
  "Economía": "https://api.codetabs.com/v1/proxy?quest=https://feeds.bbci.co.uk/news/world/rss.xml"
};

async function obtenerFeed(categoria) {
  const feedUrl = feedsPorCategoria[categoria];
  if (!feedUrl) return null;

  try {
    const response = await fetch(feedUrl);
    const text = await response.text();
    const parser = new DOMParser();
    const xml = parser.parseFromString(text, "application/xml");
    return xml;
  } catch (error) {
    console.error("Error al obtener feed:", error);
    return null;
  }
}

function limpiarNoticias() {
  document.getElementById("noticias").innerHTML = "";
}

function mostrarError() {
  const contenedor = document.getElementById("noticias");
  contenedor.innerHTML = '<p class="text-center text-lg">No se pudieron cargar noticias.</p>';
}

async function resumirNoticia(titulo, descripcion) {
  try {
    const response = await fetch("https://api.mistral.shortwave.dev/api/summarize", {
      method: "POST",
      headers: {
        "Content-Type": "application/json"
      },
      body: JSON.stringify({ text: `${titulo}. ${descripcion}` })
    });

    const data = await response.json();
    return data.summary || descripcion;
  } catch (error) {
    console.error("Error al resumir noticia:", error);
    return descripcion;
  }
}

function extraerImagen(item) {
  const media = item.getElementsByTagName("media:thumbnail")[0] || item.getElementsByTagName("media:content")[0];
  return media ? media.getAttribute("url") : null;
}

async function mostrarNoticias(xml) {
  if (!xml) {
    mostrarError();
    return;
  }

  const items = xml.getElementsByTagName("item");
  const contenedor = document.getElementById("noticias");
  contenedor.innerHTML = "";

  for (let i = 0; i < Math.min(8, items.length); i++) {
    const item = items[i];
    const titulo = item.getElementsByTagName("title")[0].textContent;
    const descripcion = item.getElementsByTagName("description")[0].textContent;
    const enlace = item.getElementsByTagName("link")[0].textContent;
    const imagen = extraerImagen(item);
    const resumen = await resumirNoticia(titulo, descripcion);

    const tarjeta = document.createElement("div");
    tarjeta.className = "bg-white p-4 rounded shadow max-w-sm mx-auto";

    tarjeta.innerHTML = `
      <h2 class="text-lg font-bold mb-2">${titulo}</h2>
      ${imagen ? `<img src="${imagen}" alt="imagen" class="w-full h-auto rounded mb-2">` : ""}
      <p class="mb-2">${resumen}</p>
      <a href="${enlace}" target="_blank" class="bg-blue-500 text-white px-4 py-2 rounded">Leer más</a>
    `;

    contenedor.appendChild(tarjeta);
  }
}

document.getElementById("categoria").addEventListener("change", async function () {
  limpiarNoticias();
  const categoria = this.value;
  const xml = await obtenerFeed(categoria);
  mostrarNoticias(xml);
});

// Cargar noticias por defecto al inicio
(async () => {
  const xml = await obtenerFeed("Internacional");
  mostrarNoticias(xml);
})();
