<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Resumen de Noticias con IA (Mistral)</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <style>
    body { background-color: #f1f1f1; }
    .header { background-color: #111; color: white; padding: 1rem; text-align: center; font-size: 1.5rem; font-weight: bold; }
    .card { margin: 1rem; }
    .category-select { margin: 1rem auto; max-width: 400px; }
  </style>
</head>
<body>
  <div class="header">Resumen de Noticias con IA (Mistral)</div>

  <div class="container">
    <div class="category-select">
      <select id="category" class="form-select">
        <option value="internacional">Internacional</option>
        <option value="nacional">Nacional</option>
        <option value="europa">Europa</option>
        <option value="deportes">Deportes</option>
        <option value="cultura">Cultura</option>
        <option value="tecnologia">Tecnología</option>
        <option value="ciencia">Ciencia</option>
        <option value="economia">Economía</option>
      </select>
    </div>
    <div id="news-container" class="row justify-content-center"></div>
  </div>

  <script>
    const token = "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";
    const mistralModel = "mistralai/Mistral-7B-Instruct-v0.2";

    const feedsPorCategoria = {
      internacional: [
        "https://feeds.bbci.co.uk/news/world/rss.xml",
        "https://rss.nytimes.com/services/xml/rss/nyt/World.xml",
        "https://www.theguardian.com/world/rss",
        "https://elpais.com/rss/elpais/internacional.xml"
      ],
      nacional: [
        "https://elpais.com/rss/elpais/espana.xml",
        "https://feeds.elconfidencial.com/espana/rss.xml"
      ],
      europa: [
        "https://www.dw.com/es/europa/rss-feeds/s-100838",
        "https://elpais.com/rss/elpais/internacional.xml"
      ],
      deportes: [
        "https://as.com/rss/futbol.xml",
        "https://feeds.elconfidencial.com/deportes/rss.xml"
      ],
      cultura: [
        "https://feeds.elconfidencial.com/cultura/rss.xml",
        "https://elpais.com/rss/cultura.xml"
      ],
      tecnologia: [
        "https://feeds.elconfidencial.com/tecnologia/rss.xml",
        "https://www.genbeta.com/tag/rss.xml"
      ],
      ciencia: [
        "https://www.agenciasinc.es/rss/Noticias",
        "https://feeds.elconfidencial.com/alma-corazon-vida/ciencia/rss.xml"
      ],
      economia: [
        "https://feeds.elconfidencial.com/economia/rss.xml",
        "https://www.eleconomista.es/rss/rss-economia.php"
      ]
    };

    async function getFeedArticles(feedUrl) {
      try {
        const response = await fetch(`https://api.allorigins.win/get?url=${encodeURIComponent(feedUrl)}`);
        const data = await response.json();
        const parser = new DOMParser();
        const xml = parser.parseFromString(data.contents, "text/xml");
        const items = xml.querySelectorAll("item");
        return Array.from(items).slice(0, 6).map(item => {
          const content = item.querySelector("content\\:encoded")?.textContent || item.querySelector("description")?.textContent || "";
          const imgMatch = content.match(/<img[^>]+src\s*=\s*['"]([^'"]+)['"]/);
          const image = item.querySelector("media\\:content")?.getAttribute("url") ||
                        item.querySelector("media\\:thumbnail")?.getAttribute("url") ||
                        item.querySelector("enclosure")?.getAttribute("url") ||
                        (imgMatch ? imgMatch[1] : "https://via.placeholder.com/300x150");

          return {
            title: item.querySelector("title")?.textContent,
            link: item.querySelector("link")?.textContent,
            description: content.replace(/<[^>]+>/g, '').substring(0, 1000),
            image: image
          };
        });
      } catch (error) {
        console.error("Error al obtener feed:", feedUrl, error);
        return [];
      }
    }

    async function summarizeText(text) {
      try {
        const response = await fetch("https://api-inference.huggingface.co/models/" + mistralModel, {
          method: "POST",
          headers: {
            Authorization: `Bearer ${token}`,
            "Content-Type": "application/json"
          },
          body: JSON.stringify({ inputs: `Resúmelo brevemente en español: ${text}` })
        });

        const result = await response.json();
        if (Array.isArray(result)) return result[0]?.generated_text || "(No se pudo resumir)";
        if (result?.error) return `(Error: ${result.error})`;
        return "(No se pudo resumir)";
      } catch (err) {
        return `(Error de conexión)`;
      }
    }

    async function mostrarNoticias() {
      const categoria = document.getElementById("category").value;
      const container = document.getElementById("news-container");
      container.innerHTML = "<p>Cargando noticias...</p>";

      const feeds = feedsPorCategoria[categoria] || [];
      let allArticles = [];

      for (const feed of feeds) {
        const articles = await getFeedArticles(feed);
        allArticles = allArticles.concat(articles);
      }

      const topArticles = allArticles.slice(0, 12);

      const tarjetas = await Promise.all(topArticles.map(async (articulo) => {
        const resumen = articulo.description ? await summarizeText(articulo.description) : "(Sin contenido para resumir)";
        return `
          <div class="col-md-4">
            <div class="card">
              <img src="${articulo.image}" class="card-img-top" alt="Imagen de noticia">
              <div class="card-body">
                <h5 class="card-title">${articulo.title}</h5>
                <p class="card-text">${resumen}</p>
                <a href="${articulo.link}" target="_blank" class="btn btn-primary">Leer más</a>
              </div>
            </div>
          </div>
        `;
      }));

      container.innerHTML = tarjetas.join("");
    }

    document.getElementById("category").addEventListener("change", mostrarNoticias);
    mostrarNoticias();
  </script>
</body>
</html>
